<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="kr.co.kosmo.project_back.admin.mapper.AdminQuestionMapper">

    <resultMap id="QuestionResponseMap" type="kr.co.kosmo.project_back.admin.dto.QuestionResponseDto">
        <id property="id" column="id" />
        <result property="userId" column="userId" />
        <result property="productId" column="productId" />
        <result property="title" column="title" />
        <result property="content" column="content" />
        <result property="questionStatus" column="questionStatus" />
        <result property="type" column="type" />
        <result property="createdAt" column="createdAt" />
        
        <association property="answer" column="id" javaType="kr.co.kosmo.project_back.admin.dto.QuestionAnswerDto" select="findAnswerByQuestionId" />
        
        <collection property="questionImages" column="id" ofType="kr.co.kosmo.project_back.admin.dto.QuestionImageDto" 
                select="kr.co.kosmo.project_back.admin.mapper.AdminQuestionImageMapper.findImagesByQuestionId" />
    </resultMap>

    <select id="countQuestionList" parameterType="kr.co.kosmo.project_back.admin.dto.QuestionSearchDto" resultType="int">
        SELECT COUNT(*) FROM Bg_Question q
        <where>
            <if test="startDate != null and startDate != ''"> AND date(q.created_at) &gt;= date(#{startDate}) </if>
            <if test="endDate != null and endDate != ''"> AND date(q.created_at) &lt;= date(#{endDate}) </if>
            <if test="questionStatus != null and questionStatus != ''"> AND q.question_status = #{questionStatus} </if>
            <if test="type != null and type != ''"> AND q.type = #{type} </if>
            <if test="keyword != null and keyword != ''">
                <choose>
                    <when test="keywordType == 'title'"> AND q.title LIKE '%' || #{keyword} || '%' </when>
                    <when test="keywordType == 'content'"> AND q.content LIKE '%' || #{keyword} || '%' </when>
                    <otherwise> AND (q.title LIKE '%' || #{keyword} || '%' OR q.content LIKE '%' || #{keyword} || '%') </otherwise>
                </choose>
            </if>
        </where>
    </select>

    <select id="findQuestionList" parameterType="kr.co.kosmo.project_back.admin.dto.QuestionSearchDto" resultMap="QuestionResponseMap">
        SELECT 
            id, 
            user_id AS userId, 
            product_id AS productId, 
            title, 
            content, 
            question_status AS questionStatus, 
            type, 
            created_at AS createdAt
        FROM Bg_Question
        <where>
            <if test="startDate != null and startDate != ''"> AND date(created_at) &gt;= date(#{startDate}) </if>
            <if test="endDate != null and endDate != ''"> AND date(created_at) &lt;= date(#{endDate}) </if>
            <if test="questionStatus != null and questionStatus != ''"> AND question_status = #{questionStatus} </if>
            <if test="type != null and type != ''"> AND type = #{type} </if>
            <if test="keyword != null and keyword != ''">
                <choose>
                    <when test="keywordType == 'title'"> AND title LIKE '%' || #{keyword} || '%' </when>
                    <when test="keywordType == 'content'"> AND content LIKE '%' || #{keyword} || '%' </when>
                    <otherwise> AND (title LIKE '%' || #{keyword} || '%' OR content LIKE '%' || #{keyword} || '%') </otherwise>
                </choose>
            </if>
        </where>
        ORDER BY created_at DESC
        LIMIT #{size} OFFSET #{offset}
    </select>

    <select id="findAnswerByQuestionId" parameterType="int" resultType="kr.co.kosmo.project_back.admin.dto.QuestionAnswerDto">
        SELECT 
            question_id AS questionid, 
            content 
        FROM Bg_Answer 
        WHERE question_id = #{id} 
        LIMIT 1
    </select>

    <select id="findById" parameterType="int" resultMap="QuestionResponseMap">
        SELECT 
            id, user_id AS userId, product_id AS productId, title, content, 
            question_status AS questionStatus, type, created_at AS createdAt
        FROM Bg_Question 
        WHERE id = #{id}
    </select>

    <insert id="insertAnswer" parameterType="kr.co.kosmo.project_back.admin.dto.QuestionAnswerDto">
        INSERT INTO Bg_Answer (question_id, content) VALUES (#{questionid}, #{content})
    </insert>

    <update id="updateQuestionStatus" parameterType="int">
        UPDATE Bg_Question SET question_status = 'ANSWERED' WHERE id = #{questionId}
    </update>

</mapper>