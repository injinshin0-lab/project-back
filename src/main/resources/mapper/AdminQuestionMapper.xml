<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="kr.co.kosmo.project_back.admin.mapper.AdminQuestionMapper">

    <resultMap id="QuestionResponseMap" type="kr.co.kosmo.project_back.admin.dto.QuestionResponseDto">
        <id property="id" column="id" />
        <result property="userId" column="userId" />
        <result property="productId" column="productId" />
        <result property="title" column="title" />
        <result property="content" column="content" />
        <result property="questionStatus" column="questionStatus" />
        <result property="type" column="type" />
        <result property="createdAt" column="createdAt" />

        <result property="productName" column="productName" />
        <result property="productImageUrl" column="productImageUrl" />
        
        <association property="answer" column="id" javaType="kr.co.kosmo.project_back.admin.dto.QuestionAnswerDto" select="findAnswerByQuestionId" />
        
        <collection property="questionImages" column="id" ofType="kr.co.kosmo.project_back.admin.dto.QuestionImageDto" 
                select="kr.co.kosmo.project_back.admin.mapper.AdminQuestionImageMapper.findImagesByQuestionId" />
    </resultMap>

    <select id="countQuestionList" parameterType="kr.co.kosmo.project_back.admin.dto.QuestionSearchDto" resultType="int">
        SELECT COUNT(*) FROM bg_question q
        <where>
            <if test="startDate != null and startDate != ''"> AND date(q.created_at) &gt;= date(#{startDate}) </if>
            <if test="endDate != null and endDate != ''"> AND date(q.created_at) &lt;= date(#{endDate}) </if>
            <if test="questionStatus != null and questionStatus != ''"> AND q.question_status = #{questionStatus} </if>
            <if test="type != null and type != ''"> AND q.type = #{type} </if>
            <if test="keyword != null and keyword != ''">
                <choose>
                    <when test="keywordType == 'title'"> AND q.title LIKE CONCAT('%', #{keyword}, '%') </when>
                    <when test="keywordType == 'content'"> AND q.content LIKE CONCAT('%', #{keyword}, '%') </when>
                    <otherwise> AND (q.title LIKE CONCAT('%', #{keyword}, '%') OR q.content LIKE CONCAT('%', #{keyword}, '%')) </otherwise>
                </choose>
            </if>
        </where>
    </select>

    <select id="findQuestionList" parameterType="kr.co.kosmo.project_back.admin.dto.QuestionSearchDto" resultMap="QuestionResponseMap">
        SELECT 
            q.id, 
            q.user_id AS userId, 
            u.user_name AS userName,
            q.product_id AS productId, 
            q.title, 
            q.content, 
            q.question_status AS questionStatus, 
            q.type, 
            q.created_at AS createdAt,
            p.product_name AS productName,
            p.image_url AS productImageUrl
        FROM bg_question q
        LEFT JOIN bg_product p ON q.product_id = p.id
        LEFT JOIN bg_user u ON q.user_id = u.id
        <where>
            <if test="startDate != null and startDate != ''"> AND date(q.created_at) &gt;= date(#{startDate}) </if>
            <if test="endDate != null and endDate != ''"> AND date(q.created_at) &lt;= date(#{endDate}) </if>
            <if test="questionStatus != null and questionStatus != ''"> AND q.question_status = #{questionStatus} </if>
            <if test="type != null and type != ''"> AND q.type = #{type} </if>
            <if test="keyword != null and keyword != ''">
                <choose>
                    <when test="keywordType == 'title'"> AND q.title LIKE CONCAT('%', #{keyword}, '%') </when>
                    <when test="keywordType == 'content'"> AND q.content LIKE CONCAT('%', #{keyword}, '%') </when>
                    <otherwise> AND (q.title LIKE CONCAT('%', #{keyword}, '%') OR q.content LIKE CONCAT('%', #{keyword}, '%')) </otherwise>
                </choose>
            </if>
        </where>
        ORDER BY q.created_at DESC
        LIMIT #{size} OFFSET #{offset}
    </select>

    <select id="findAnswerByQuestionId" parameterType="int" resultType="kr.co.kosmo.project_back.admin.dto.QuestionAnswerDto">
        SELECT 
            question_id AS questionid, 
            content 
        FROM bg_answer 
        WHERE question_id = #{id} 
        LIMIT 1
    </select>

    <select id="findById" parameterType="int" resultMap="QuestionResponseMap">
        SELECT 
            q.id, q.user_id AS userId, q.product_id AS productId, q.title, q.content, 
            q.question_status AS questionStatus, q.type, q.created_at AS createdAt,
            p.product_name AS productName,
            p.image_url AS productImageUrl
        FROM bg_question q
        LEFT JOIN bg_product p ON q.product_id = p.id
        WHERE q.id = #{id}
    </select>

    <insert id="insertAnswer" parameterType="kr.co.kosmo.project_back.admin.dto.QuestionAnswerDto">
        INSERT INTO bg_answer (question_id, content) VALUES (#{questionid}, #{content})
    </insert>

    <update id="updateQuestionStatus" parameterType="int">
        UPDATE bg_question 
        SET question_status = '답변완료' 
        WHERE id = #{questionId}
    </update>

</mapper>